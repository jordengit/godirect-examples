<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="Mark Otto, Jacob Thornton, and Bootstrap contributors">
    <meta name="generator" content="Hugo 0.84.0">
    <title>Veriner Test</title>
    <!-- Bootstrap core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <style>
        main .container ul.nav {
            gap: 10px;
        }
    </style>

    <!-- Custom styles for this template -->
</head>

<body>
    <main>
        <div class="container">
            <header
                class="d-flex flex-wrap align-items-center justify-content-center justify-content-md-between py-3 mb-4 border-bottom">
                <ul class="nav nav-pills">
                    <li class="nav-item"><a href="#" class="nav-link active" onclick="start()">Start</a></li>
                    <li class="nav-item"><a href="#" class="nav-link active" onclick="stop()">Stop</a></li>
                    <li class="nav-item"><a href="#" class="nav-link active" onclick="save()">Save</a></li>
                    <li class="nav-item"><a href="#" class="nav-link active" onclick="draw()">Draw</a></li>
                </ul>
            </header>
        </div>


        <div class="container">
            Sample Rate: <input type="number" name="samplerate" id="samplerate" value="10"
                style="width: 80px;">&nbsp;ms<br />
            <span id="dur">0</span> &nbsp;ms<br />
            <span id="measurements">0</span> &nbsp;measurements<br />
            <div style="float: left; width: 80%">
                <div style="min-width: 150px; max-width: 600px; max-height: 800px; min-height: 150px;">
                    <canvas id="myChart"></canvas>
                </div>
            </div>
        </div>
    </main>


    <script src="js/FileSaver.min.js"></script>
    <script src="js/chart.js"></script>
    <script>
        // setup the calculator
        let toggleCollect = false;
        let collectcount = 0;
        let savedata = [];

        let startts = 0;
        let endts = 0;

        let collecting = false;
        let delta = 1.0;

        const output = document.querySelector('#output');
        const txtdur = document.querySelector('#dur');
        const txtmeasurements = document.querySelector('#measurements');
        const valsamplerate = document.querySelector('#samplerate');

        let gdxDevice;

        const start = async () => {
            startts = new Date().getTime();
            endts = 0;
        }

        var getdata = async () => {
            const res = await fetch('http://127.0.0.1:8000/dump', {
                method: 'GET'
            });

            return await res.json()
        }
        const stop = async () => {
            endts = new Date().getTime();
            getdata().then(resp => {
                let collectary = JSON.parse(resp.replaceAll("'", '\"'));
                savedata = collectary.filter(o => o[3] > startts && o[3] < endts);

                let dur = endts - startts;
                txtdur.textContent = dur;
                txtmeasurements.textContent = savedata.length;
            });
        }

        const draw = async () => {
            const ctx = document.getElementById('myChart');

            const data = {
                //labels: savedata.map(o=>new Date(o.t).toJSON().replace('T', ' ').replace('Z', '')),
                labels: savedata.map((o, i) => i),
                datasets: [{
                    label: 'My First dataset',
                    backgroundColor: '#00FF0066',
                    borderColor: '#00FF0000',
                    fill: false,
                    data: savedata.map(o => o[2]),
                }]
            };

            if (Chart.getChart("myChart")) Chart.getChart("myChart").destroy()
            chart = new Chart(ctx, {
                type: 'line',
                data: data,
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Chart.js Line Chart'
                        }
                    }
                },
            });
        }
        let chart = null;
        const save = async () => {
            // Save content to a file

            let summarydata = savedata.reduce((res, o) => res += `${o[3]} => ${o[2]}\n`, "");

            var blob = new Blob([summarydata], { type: "text/plain;charset=ascii" });
            saveAs(blob, "data.txt");
        }

        const save1 = async () => {
            // Save content to a file

            let summarydata = summmary.reduce((res, o) => res += `${o[3]} => ${o[2]}\n`, "");

            var blob = new Blob([summarydata], { type: "text/plain;charset=ascii" });
            saveAs(blob, "data.txt");
        }

    </script>
</body>

</html>